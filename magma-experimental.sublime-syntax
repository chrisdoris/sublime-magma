%YAML 1.2
---
# TODO:
# - Sprintf
# - exists/forall/rep/random/select/else/Self/assigned
# - ranges (like [1..3 by 2])
# - improve generic constructor
# - special constructors (rec, recformat, hom, map, etc?)
# - case expression
# - regular expression syntax

name: Magma (experimental)
file_extensions: [magma, mag]
scope: source.magma

variables:
  escape_char: \\.
  format_char: '%[-]?[0-9]*(\.[0-9]*)?[oOmh]|%\*[oOmh]|%%'
  bad_format_char: '%'
  identifier: '\b[a-zA-Z_][a-zA-Z_0-9]*\b'

contexts:

  # MAIN

  main:
    - include: statement

  statement:
    - include: print_statement
    - include: vprint_statement
    - include: printf_statement
    - include: vprintf_statement
    - include: fprintf_statement
    - include: delete_statement
    - include: clear_statement
    - include: freeze_statement
    - include: exit_statement
    - include: quit_statement
    - include: import_statement
    - include: time_statement
    - include: vtime_statement
    - include: assert_statement
    - include: assert2_statement
    - include: assert3_statement
    - include: error_statement
    - include: read_statement
    - include: readi_statement
    - include: local_statement
    - include: forward_statement
    - include: eval_statement
    - include: declare_statement
    - include: if_statement
    - include: case_statement
    - include: while_statement
    - include: repeat_statement
    - include: for_statement
    - include: load_statement
    - include: iload_statement
    - include: save_statement
    - include: restore_statement
    - include: intrinsic_statement
    - include: function_statement
    - include: procedure_statement
    - include: return_statement
    - include: break_statement
    - include: continue_statement
    - include: require_statement
    - include: requirerange_statement
    - include: requirege_statement
    - include: try_statement
    - include: syscall_statement
    - include: assignment_or_expression_statement

  expression:
    - include: literal
    - include: logical_operator
    - include: comparison_operator
    - include: arithmetic_operator
    - include: other_operator
    - include: where_expression
    - include: sprintf_call
    - include: parentheses
    - include: aggregate
    - include: constructor
    - include: identifier

  literal:
    - include: string_literal
    - include: number_literal
    - include: symbol_literal
    - include: boolean_literal

  aggregate:
    - include: mset
    - include: iset
    - include: set
    - include: seq
    - include: tuple

  # UTILS

  illegal:
    - match: '.'
      scope: invalid.illegal.magma

  string_chars:
    - match: '{{escape_char}}'
      scope: constant.character.escape.magma
    - match: '{{format_char}}'
      scope: constant.character.escape.magma

  format_string_chars:
    - include: string_chars
    - match: '{{bad_format_char}}'
      scope: invalid.illegal.magma

  # PROTOTYPE

  prototype:
    - include: space

  space:
    - include: comment
    - include: whitespace

  comment:
    - include: line_comment
    - include: block_comment

  whitespace:
    - match: \s+

  line_comment:
    - match: //.*
      scope: comment.line.double-slash.magma

  block_comment:
    - match: /\*
      push:
        - meta_scope: comment.block.magma
        - match: \*/
          pop: true

  # LITERALS

  string_literal:
    - match: '"'
      push:
        - meta_scope: string.quoted.double.magma
        - meta_include_prototype: false
        - include: string_chars
        - match: '"'
          set: OPT_post_operator_POP

  number_literal:
    - match: '[+-]?\b([0-9]+)(\.[0-9]+)?([eE][-+]?[0-9]+)?([pP][0-9]+)?\b'
      scope: constant.numeric.magma
      push: OPT_post_operator_POP

  symbol_literal:
    - match: "'[^']*'"
      scope: constant.language.symbol.magma
      push: OPT_post_operator_POP

  boolean_literal:
    - match: '\b(true|false)\b'
      scope: constant.language.boolean.magma
      push: OPT_post_operator_POP

  # IDENTIFIER

  identifier:
    - match: '{{identifier}}'
      scope: meta.identifier.magma
      push: OPT_post_operator_POP

  # POST OPERATOR

  OPT_post_operator_POP:
    - include: function_call_operator_POP
    - include: indexing_operator_POP
    - include: backtick_operator_POP
    - include: doublequote_operator_POP
    - include: dot_operator_POP
    - include: constructor_operator_POP
    - match: '(?=.)'
      pop: true

  constructor_operator_POP:
    - match: '<'
      set:
        - constructor_METASCOPE_POP
        - constructor_operator_2_POP

  constructor_METASCOPE_POP:
    - meta_scope: meta.operator.constructor.magma
    - match: ''
      pop: true

  constructor_operator_2_POP:
    - match: '>'
      set: OPT_post_operator_POP
    - include: expression

  function_call_operator_POP:
    - match: '\('
      set:
        - function_call_METASCOPE_POP
        - function_call_operator_2_POP

  function_call_METASCOPE_POP:
    - meta_scope: meta.operator.function_call.magma
    - match: ''
      pop: true

  function_call_operator_2_POP:
    - match: '\)'
      set: OPT_post_operator_POP
    - include: REQ_function_call_arguments_POP

  REQ_function_call_arguments_POP:
    - match: '\)'
      set: OPT_post_operator_POP
    - match: ':'
      set: REQ_function_call_optional_arguments_POP
    - include: expression

  REQ_function_call_optional_arguments_POP:
    - match: '\)'
      set: OPT_post_operator_POP
    - match: '{{identifier}}'
      scope: variable.parameter.magma
      set:
        - match: ':='
          scope: keyword.operator.assignment.magma
          set:
            - match: ','
              set: REQ_function_call_optional_arguments_POP
            - match: '\)'
              set: OPT_post_operator_POP
            - include: expression
        - include: illegal
    - include: illegal

  REQ_function_call_next_arguments_POP:
    - match: '\)'
      set: OPT_post_operator_POP
    - match: ':'
      set: REQ_function_call_optional_arguments_POP
    - match: ','
      set: REQ_function_call_arguments_POP
    - include: illegal

  indexing_operator_POP:
    - match: '\['
      set:
        - meta_scope: meta.operator.indexing.magma
        - match: '\]'
          set: OPT_post_operator_POP
        - include: expression

  backtick_operator_POP:
    - match: '`'
      scope: keyword.operator.magma
      set:
        - meta_scope: meta.operator.backtick.magma
        - match: '{{identifier}}'
          set: OPT_post_operator_POP
        - include: illegal

  doublequote_operator_POP:
    - match: '"'
      scope: keyword.operator.magma meta.operator.doublequote.magma
      pop: true

  dot_operator_POP:
    - match: '\.'
      scope: keyword.operator.magma meta.operator.dot.magma
      pop: true

  # WHERE

  where_expression:
    - match: '\bwhere\b'
      scope: keyword.other.magma
      push:
        - meta_scope: meta.expression.where.magma
        - match: '\bis\b'
          scope: keyword.other.magma
          pop: true
        - match: ':='
          scope: keyword.operator.assignment.magma
          pop: true
        - include: expression

  # PRINT

  print_statement:
    - match: '\bprint\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - print_args_POP

  print_args_POP:
    - match: ';'
      pop: true
    - include: print_level_POP
    - include: expression

  print_level_POP:
    - match: ':'
      set:
        - match: '\b(Default|Minimal|Maximal|Magma)\b'
          scope: keyword.other.magma
          set: REQ_blank_statement_POP
        - include: illegal

  # VPRINT

  vprint_statement:
    - match: '\bvprint\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_list_statement_POP
        - REQ_verbosity_specifier_POP

  REQ_verbosity_specifier_POP:
    - match: '{{identifier}}'
      scope: entity.name.class.verbosity.magma
      set:
        - match: ':'
          pop: true
        - include: expression
    - include: illegal

  # PRINTF

  printf_statement:
    - match: '\bprintf\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_list_statement_POP
        - REQ_format_string_literal_POP

  expression_list_statement_POP:
    - include: expression
    - match: ';'
      pop: true

  REQ_format_string_literal_POP:
    - match: '"'
      set:
        - meta_scope: string.quoted.double.magma
        - meta_include_prototype: false
        - include: format_string_chars
        - match: '"'
          pop: true
    - include: illegal

  # VPRINTF

  vprintf_statement:
    - match: '\bvprintf\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_list_statement_POP
        - REQ_format_string_literal_POP
        - REQ_verbosity_specifier_POP

  # FPRINTF

  fprintf_statement:
    - match: '\bfprintf\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_list_statement_POP

  # TIME

  time_statement:
    - match: '\btime\b'
      scope: keyword.other.magma

  # VTIME

  vtime_statement:
    - match: '\bvtime\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_verbosity_specifier_POP

  # DELETE

  delete_statement:
    - match: '\bdelete\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP
        - REQ_identifier_POP

  REQ_identifier_POP:
    - match: '{{identifier}}'
      pop: true
    - include: illegal


  # CLEAR

  clear_statement:
    - match: '\bclear\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP

  # FREEZE

  freeze_statement:
    - match: '\bfreeze\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP

  REQ_blank_statement_POP:
    - match: ';'
      pop: true
    - include: illegal

  # EXIT

  exit_statement:
    - match: '\bexit\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP

  # QUIT

  quit_statement:
    - match: '\bquit\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP

  # ASSERT

  assert_statement:
    - match: '\bassert\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  # ASSERT2

  assert2_statement:
    - match: '\bassert2\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  # ASSERT3

  assert3_statement:
    - match: '\bassert3\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  # ERROR

  error_statement:
    - match: '\berror\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  # IMPORT

  import_statement:
    - match: '\bimport\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - ident_list_statement_POP
        - expression_list_colon_POP

  ident_list_statement_POP:
    - match: '{{identifier}}'
      set:
        - match: ';'
          pop: true
        - match: ','
          set: ident_list_statement_POP
        - include: illegal
    - include: illegal

  expression_list_colon_POP:
    - match: ':'
      pop: true
    - include: expression

  # READ

  read_statement:
    - match: '\bread\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP
        - REQ_identifier_POP

  # READI

  readi_statement:
    - match: '\breadi\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP
        - REQ_identifier_POP

  # LOCAL

  local_statement:
    - match: '\blocal\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP
        - REQ_identifier_POP

  # FORWARD

  forward_statement:
    - match: '\bforward\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - REQ_blank_statement_POP
        - REQ_function_name_POP

  REQ_function_name_POP:
    - match: '{{identifier}}'
      scope: entity.name.function.function.magma
      pop: true
    - include: illegal

  # EVAL

  eval_statement:
    - match: '\beval\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  # LOAD

  load_statement:
    - match: '\bload\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  # ILOAD

  iload_statement:
    - match: '\biload\b'
      scope: keyword.other.magma
      push:
        - statement_METASCOPE_POP
        - expression_statement_POP

  statement_METASCOPE_POP:
    - meta_scope: meta.statement.magma
    - match: ''
      pop: true

  # SAVE

  save_statement:
    - match: '\bsave\b'
      scope: keyword.other.magma
      push:
        - save_METASCOPE_POP
        - expression_statement_POP

  save_METASCOPE_POP:
    - meta_scope: meta.statement.save.magma
    - match: ''
      pop: true

  # RESTORE

  restore_statement:
    - match: '\brestore\b'
      scope: keyword.other.magma
      push:
        - restore_METASCOPE_POP
        - expression_statement_POP

  restore_METASCOPE_POP:
    - meta_scope: meta.statement.restore.magma
    - match: ''
      pop: true

  # IF

  if_statement:
    - match: '\bif\b'
      scope: keyword.other.magma
      push:
        - if_METASCOPE_POP
        - if_body_POP
        - if_then_POP

  if_METASCOPE_POP:
    - meta_scope: meta.statement.if.magma
    - match: ''
      pop: true

  if_then_POP:
    - match: '\bthen\b'
      scope: keyword.other.magma
      pop: true
    - include: expression

  if_body_POP:
    - match: '\belif\b'
      scope: keyword.other.magma
      set:
        - if_body_POP
        - if_then_POP
    - match: '\belse\b'
      scope: keyword.other.magma
      set: if_body_POP
    - match: '\bend\b'
      scope: keyword.other.magma
      set:
        - match: '\bif\b'
          scope: keyword.other.magma
          set: REQ_blank_statement_POP
        - include: illegal
    - include: statement

  # WHILE

  while_statement:
    - match: '\bwhile\b'
      scope: keyword.other.magma
      push:
        - while_METASCOPE_POP
        - while_body_POP
        - while_do_POP

  while_METASCOPE_POP:
    - meta_scope: meta.statement.while.magma
    - match: ''
      pop: true

  while_do_POP:
    - match: '\bdo\b'
      scope: keyword.other.magma
      pop: true

  while_body_POP:
    - match: '\b(end\s+while)\s*;'
      captures:
        1: keyword.other.magma
      pop: true
    - include: statement

  # REPEAT

  repeat_statement:
    - match: '\brepeat\b'
      scope: keyword.other.magma
      push:
        - repeat_METASCOPE_POP
        - repeat_body_POP

  repeat_METASCOPE_POP:
    - meta_scope: meta.statement.repeat.magma
    - match: ''
      pop: true

  repeat_body_POP:
    - match: '\buntil\b'
      scope: 'keyword.other.magma'
      set: expression_statement_POP
    - include: statement


  expression_statement_POP:
    - match: ';'
      pop: true
    - include: expression

  # OPERATORS

  logical_operator:
    - match: '\b(and|not|or|xor)\b'
      scope: keyword.operator.bool.logical.magma

  comparison_operator:
    - match: '\b(le|lt|ge|gt|eq|ne|cmpeq|cmpne|in|notin|subset|notsubset|adj|notadj)\b'
      scope: keyword.operator.comparison.magma

  arithmetic_operator:
    - match: '\+|-|/|\*|\^'
      scope: keyword.operator.arithmetic.magma

  other_operator:
    - match: '\b(div|cat|meet|join|diff|sdiff|mod)\b|#|&|`|!|@|@@|\.|\.\.|\.\.\.|~'
      scope: keyword.operator.other.magma

  # ASSIGNMENT OR EXPRESSION
  
  assignment_or_expression_statement:
    - match: '(?=.)'
      push:
        - assignment_or_expression_METASCOPE_POP
        - assignment_or_expression_statement_2_POP

  assignment_or_expression_METASCOPE_POP:
    - meta_scope: meta.statement.magma
    - match: ''
      pop: true

  assignment_or_expression_statement_2_POP:
      - match: '(\b(div|cat|meet|join|diff|sdiff|mod|or|and|xor)|(\+|-|/|\*|^))?(:=)'
        scope: keyword.operator.assignment.magma
        set: expression_statement_POP
      - include: print_level_POP
      - include: expression_statement_POP

  # SYSCALL
  # TODO: maybe add shell highlighting to the contents?
  
  syscall_statement:
    - match: '(%!)(.*)$'
      captures:
        0: meta.syscall_statement.magma
        1: keyword.other.magma
        2: meta.syscall_statement.body.magma

  # DECLARE
  
  declare_statement:
    - match: '\bdeclare\b'
      scope: keyword.other.magma
      push:
        - declare_METASCOPE_POP
        - declare_statement_2_POP

  declare_METASCOPE_POP:
    - meta_scope: meta.statement.declare.magma
    - match: ''
      pop: true

  declare_statement_2_POP:
    - include: declare_type_POP
    - include: declare_attributes_POP
    - include: declare_verbose_POP
    - include: illegal

  declare_type_POP:
    - match: '\btype\b'
      scope: keyword.other.magma
      set:
        - OPT_colon_ident_list_statement_POP
        - REQ_type_and_elttype_name_POP

  declare_attributes_POP:
    - match: '\battributes\b'
      scope: keyword.other.magma
      set:
        - OPT_colon_ident_list_statement_POP
        - REQ_type_name_POP

  declare_verbose_POP:
    - match: '\bverbose\b'
      scope: keyword.other.magma
      set:
        - REQ_semicolon_POP
        - REQ_integer_literal_POP
        - REQ_comma_POP
        - REQ_verbosity_name_POP

  REQ_semicolon_POP:
    - match: ';'
      pop: true
    - include: illegal

  REQ_integer_literal_POP:
    - match: '\b[0-9]+\b'
      scope: constant.numeric.magma
      pop: true
    - include: illegal

  REQ_comma_POP:
    - match: ','
      pop: true
    - include: illegal

  REQ_verbosity_name_POP:
    - match: '{{identifier}}'
      scope: entity.name.class.verbosity.magma
      pop: true
    - include: illegal

  REQ_type_name_POP:
    - match: '{{identifier}}'
      scope: entity.name.class.magma
      pop: true
    - include: illegal

  REQ_type_and_elttype_name_POP:
    - match: '{{identifier}}'
      scope: entity.name.class.magma
      set:
        - match: '\['
          set:
            - match: '{{identifier}}'
              scope: entity.name.class.magma
              set:
                - match: '\]'
                  pop: true
                - include: illegal
            - include: illegal
        - match: '(?=.)'
          pop: true
    - include: illegal

  OPT_colon_ident_list_statement_POP:
    - match: ':'
      set: ident_list_statement_POP
    - match: ';'
      pop: true
    - include: illegal

  # FOR
  
  for_statement:
    - match: '\bfor\b'
      scope: keyword.other.magma
      push:
        - for_METASCOPE_POP
        - for_body_POP
        - for_range_POP

  for_METASCOPE_POP:
    - meta_scope: meta.statement.for.magma
    - match: ''
      pop: true

  for_body_POP:
    - match: '\b(end\s+for)\s*;'
      captures:
        1: keyword.other.magma
      pop: true
    - include: statement

  do_POP:
    - match: '\bdo\b'
      scope: keyword.other.magma
      pop: true

  for_range_POP:
    - match: '{{identifier}}'
      set:
        - match: '\bin\b'
          scope: keyword.other.magma
          set:
            - include: do_POP
            - include: expression
        - match: ':='
          scope: keyword.operator.assignment.magma
          set:
            - match: '\bto\b'
              scope: keyword.other.magma
              set:
                - include: do_POP
                - match: '\bby\b'
                  scope: keyword.other.magma
                  set:
                    - include: do_POP
                    - include: expression
                - include: expression
            - include: expression
        - include: illegal
    - include: illegal

  # TRY

  try_statement:
    - match: '\btry\b'
      scope: keyword.other.magma
      push:
        - try_METASCOPE_POP
        - try_body_POP

  try_METASCOPE_POP:
    - meta_scope: meta.statement.try.magma
    - match: ''
      pop: true

  try_body_POP:
    - match: '\bcatch\b'
      scope: keyword.other.magma
      set:
        - match: '{{identifier}}'
          set:
            - match: '\bend\b'
              scope: keyword.other.magma
              set:
                - match: '\btry\b'
                  scope: keyword.other.magma
                  set: REQ_blank_statement_POP
                - include: illegal
            - include: statement
        - include: illegal
    - include: statement

  # REQUIRE
  
  require_statement:
    - match: '\brequire\b'
      scope: keyword.other.magma
      push:
        - require_METASCOPE_POP
        - require_arguments_POP

  require_METASCOPE_POP:
    - meta_scope: meta.statement.require.magma
    - match: ''
      pop: true

  require_arguments_POP:
    - match: ':'
      set: expression_list_statement_POP
    - include: expression

  # REQUIRERANGE
  
  requirerange_statement:
    - match: '\brequirerange\b'
      scope: keyword.other.magma
      push:
        - requirerange_METASCOPE_POP
        - expression_list_statement_POP

  requirerange_METASCOPE_POP:
    - meta_scope: meta.statement.requirerange.magma
    - match: ''
      pop: true

  # REQUIREGE

  requirege_statement:
    - match: '\brequirege\b'
      scope: keyword.other.magma
      push:
        - requirege_METASCOPE_POP
        - expression_list_statement_POP

  requirege_METASCOPE_POP:
    - meta_scope: meta.statement.requirege.magma
    - match: ''
      pop: true

  # FUNCTION

  function_statement:
    - match: '\bfunction\b'
      scope: keyword.other.magma
      push:
        - function_METASCOPE_POP
        - function_body_POP
        - REQ_function_arguments_POP
        - REQ_function_name_POP

  function_METASCOPE_POP:
    - meta_scope: meta.statement.function.magma
    - match: ''
      pop: true

  REQ_function_arguments_POP:
    - match: '\('
      set:
        - match: '\)'
          pop: true
        - match: ':'
          set: REQ_function_optional_arguments_POP
        - include: REQ_function_argument_list_POP
    - include: illegal

  REQ_function_argument_list_POP:
    - match: '{{identifier}}'
      scope: variable.parameter.magma
      set:
        - match: ','
          set: REQ_function_argument_list_POP
        - match: '\)'
          pop: true
        - match: ':'
          set: REQ_function_optional_arguments_POP
        - include: illegal
    - include: illegal

  REQ_function_optional_arguments_POP:
    - match: '{{identifier}}'
      scope: variable.parameter.magma
      set:
        - match: ':='
          set:
            - match: ','
              set: REQ_function_optional_arguments_POP
            - match: '\)'
              pop: true
            - include: expression
        - include: illegal
    - include: illegal

  function_body_POP:
    - match: '\bend\b'
      scope: keyword.other.magma
      set:
        - match: '\bfunction\b'
          scope: keyword.other.magma
          set: REQ_blank_statement_POP
        - include: illegal
    - include: statement

  # RETURN

  return_statement:
    - match: '\breturn\b'
      scope: keyword.other.magma
      push:
        - return_METASCOPE_POP
        - expression_list_statement_POP

  return_METASCOPE_POP:
    - meta_scope: meta.statement.return.magma
    - match: ''
      pop: true

  # BREAK

  break_statement:
    - match: '\bbreak\b'
      scope: keyword.other.magma
      push:
        - break_METASCOPE_POP
        - REQ_blank_statement_POP
        - OPT_ident_POP

  break_METASCOPE_POP:
    - meta_scope: meta.statement.break.magma
    - match: ''
      pop: true

  OPT_ident_POP:
    - match: '{{identifier}}'
      pop: true
    - match: '(?=.)'
      pop: true

  # CONTINUE

  continue_statement:
    - match: '\bcontinue\b'
      scope: keyword.other.magma
      push:
        - continue_METASCOPE_POP
        - REQ_blank_statement_POP
        - OPT_ident_POP

  continue_METASCOPE_POP:
    - meta_scope: meta.statement.continue.magma
    - match: ''
      pop: true

  # PROCEDURE
  
  procedure_statement:
    - match: '\bprocedure\b'
      scope: keyword.other.magma
      push:
        - procedure_METASCOPE_POP
        - procedure_body_POP
        - REQ_procedure_arguments_POP
        - REQ_procedure_name_POP

  procedure_METASCOPE_POP:
    - meta_scope: meta.statement.procedure.magma
    - match: ''
      pop: true

  REQ_procedure_name_POP:
    - match: '{{identifier}}'
      scope: entity.name.function.procedure.magma
      pop: true
    - include: illegal

  REQ_procedure_arguments_POP:
    - match: '\('
      set:
        - match: '\)'
          pop: true
        - match: ':'
          set: REQ_procedure_optional_arguments_POP
        - include: REQ_procedure_argument_list_POP
    - include: illegal

  REQ_procedure_argument_list_POP:
    - match: '{{identifier}}'
      scope: variable.parameter.magma
      set:
        - match: ','
          set: REQ_procedure_argument_list_POP
        - match: '\)'
          pop: true
        - match: ':'
          set: REQ_procedure_optional_arguments_POP
        - include: illegal
    - match: '~'
      scope: keyword.operator.other.magma
      set:
        - match: '{{identifier}}'
          scope: variable.parameter.magma
          set:
            - match: ','
              set: REQ_procedure_argument_list_POP
            - match: '\)'
              pop: true
            - match: ':'
              set: REQ_procedure_optional_arguments_POP
            - include: illegal
        - include: illegal
    - include: illegal

  REQ_procedure_optional_arguments_POP:
    - include: REQ_function_optional_arguments_POP

  procedure_body_POP:
    - match: '\bend\b'
      scope: keyword.other.magma
      set:
        - match: '\bprocedure\b'
          scope: keyword.other.magma
          set: REQ_blank_statement_POP
        - include: illegal
    - include: statement

  # INTRINSIC
  
  intrinsic_statement:
    - match: '\bintrinsic\b'
      scope: keyword.other.magma
      push:
        - intrinsic_METASCOPE_POP
        - intrinsic_body_POP
        - REQ_intrinsic_documentation_POP
        - OPT_intrinsic_return_type_POP
        - REQ_intrinsic_arguments_POP
        - REQ_intrinsic_name_POP

  intrinsic_METASCOPE_POP:
    - meta_scope: meta.statement.intrinsic.magma
    - match: ''
      pop: true

  REQ_intrinsic_name_POP:
    - match: '{{identifier}}'
      scope: entity.name.function.intrinsic.magma
      pop: true
    - include: illegal

  REQ_intrinsic_arguments_POP:
    - match: '\('
      set:
        - match: '\)'
          pop: true
        - match: ':'
          set: REQ_intrinsic_optional_argument_list_POP
        - include: REQ_intrinsic_argument_list_POP

  REQ_intrinsic_argument_list_POP:
    - match: '~'
      scope: keyword.operator.other.magma
      set: REQ_intrinsic_argument_list_2_POP
    - include: REQ_intrinsic_argument_list_2_POP

  REQ_intrinsic_argument_list_2_POP:
    - match: '{{identifier}}'
      scope: variable.parameter.magma
      set:
        - REQ_intrinsic_next_argument_POP
        - OPT_intrinsic_argument_type_POP
    - include: illegal

  OPT_intrinsic_argument_type_POP:
    - match: '::'
      set: REQ_type_POP
    - match: '(?=.)'
      pop: true

  type_POP:
    - include: any_type_POP
    - include: iset_type_POP
    - include: mset_type_POP
    - include: tuple_type_POP
    - include: setseq_type_POP
    - include: simple_type_POP
    - include: sequence_type_POP
    - include: set_type_POP
    - include: seq_type_POP

  REQ_type_POP:
    - include: type_POP
    - include: illegal

  any_type_POP:
    - match: '\.'
      scope: entity.name.class.any.magma
      pop: true

  simple_type_POP:
    - match: '{{identifier}}'
      scope: entity.name.class.magma
      set:
        - match: '\['
          set:
            - match: '\]'
              pop: true
            - include: type_list
            - include: illegal
        - match: '(?=.)'
          pop: true

  type_list:
    - match: '(?=.)'
      push: type_POP

  iset_type_POP:
    - match: '\{@'
      scope: entity.name.class.iset.magma
      set:
        - match: '@\}'
          scope: entity.name.class.iset.magma
          pop: true
        - include: type_list
        - include: illegal

  mset_type_POP:
    - match: '\{\*'
      scope: entity.name.class.mset.magma
      set:
        - match: '\*\}'
          scope: entity.name.class.mset.magma
          pop: true
        - include: type_list
        - include: illegal

  tuple_type_POP:
    - match: '<'
      scope: entity.name.class.tuple.magma
      set:
        - match: '>'
          scope: entity.name.class.tuple.magma
          pop: true
        - include: type_list
        - include: illegal

  setseq_type_POP:
    - match: '\{\['
      scope: entity.name.class.setseq.magma
      set:
        - match: '\]\}'
          scope: entity.name.class.setseq.magma
          pop: true
        - include: type_list
        - include: illegal

  set_type_POP:
    - match: '\{'
      scope: entity.name.class.set.magma
      set:
        - match: '\}'
          scope: entity.name.class.set.magma
          pop: true
        - include: type_list
        - include: illegal

  seq_type_POP:
    - match: '\['
      scope: entity.name.class.seq.magma
      set:
        - match: '\]'
          scope: entity.name.class.seq.magma
          pop: true
        - include: type_list
        - include: illegal

  REQ_intrinsic_next_argument_POP:
    - match: ','
      set: REQ_intrinsic_argument_list_POP
    - match: ':'
      set: REQ_intrinsic_optional_argument_list_POP
    - match: '\)'
      pop: true
    - include: illegal

  OPT_intrinsic_return_type_POP:
    - match: '->'
      set: REQ_type_POP
    - match: '(?=.)'
      pop: true

  REQ_intrinsic_documentation_POP:
    - match: '(\{\s*(")\s*\})'
      captures:
        1: comment.block.documentation.intrinsic.magma
        2: constant.character.escape.magma
      pop: true
    - match: '\{'
      set:
        - meta_scope: comment.block.documentation.intrinsic.magma
        - match: '\\.'
          scope: constant.character.escape.magma
        - match: '\}'
          pop: true
    - include: illegal

  REQ_intrinsic_optional_argument_list_POP:
    - include: REQ_function_optional_arguments_POP

  intrinsic_body_POP:
    - match: '\bend\b'
      scope: keyword.other.magma
      set:
        - match: '\bintrinsic\b'
          scope: keyword.other.magma
          set: REQ_blank_statement_POP
        - include: illegal
    - include: statement

  case_statement:
    - match: '\bcase\b'
      scope: keyword.other.magma
      push:
        - case_METASCOPE_POP
        - case_body_POP
        - case_args_POP

  case_METASCOPE_POP:
    - meta_scope: meta.statement.case.magma
    - match: ''
      pop: true

  case_body_POP:
    - match: '\bend\b'
      scope: keyword.other.magma
      set:
        - match: '\bcase\b'
          scope: keyword.other.magma
          set: REQ_blank_statement_POP
        - include: illegal
    - match: '\bwhen\b'
      scope: keyword.other.magma
      set:
        - match: ':'
          set: case_body_POP
        - include: expression
    - match: '\belse\b'
      scope: keyword.other.magma
      set: case_body_POP
    - include: statement

  case_args_POP:
    - match: ':'
      pop: true
    - include: expression

  # SPRINTF CALL

  # sprintf_call:
  #   - match: '\bSprintf\b'
  #     push:
  #       - match: '\('
  #         set:
  #           - match: '"'
  #             set:
  #               - meta_scope: string.quoted.double.magma
  #               - meta_include_prototype: false
  #               - include: format_string_chars
  #               - match: '"'
  #                 set: REQ_function_call_next_arguments_POP
  #           - match: '\)'
  #             set: OPT_post_operator_POP
  #           - include: REQ_function_call_arguments_POP
  #       - include: OPT_post_operator_POP

  # PARENTHESES

  parentheses:
    - match: '\('
      push:
        - parentheses_METASCOPE_POP
        - parentheses_2_POP

  parentheses_METASCOPE_POP:
    - meta_scope: meta.expression.parentheses.magma
    - match: ''
      pop: true

  parentheses_2_POP:
    - match: '\)'
      set: OPT_post_operator_POP
    - include: expression

  # SET

  set:
    - match: '\{'
      push:
        - set_METASCOPE_POP
        - set_2_POP

  set_METASCOPE_POP:
    - meta_scope: meta.expression.set.magma
    - match: ''
      pop: true

  set_2_POP:
    - match: '\}'
      set: OPT_post_operator_POP
    - match: ':'
      set:
        - match: '\bin\b'
          scope: keyword.other.magma
          set:
            - match: '\}'
              set: OPT_post_operator_POP
            - match: '\|'
              set:
                - match: '\}'
                  set: OPT_post_operator_POP
                - include: expression
            - include: expression
        - include: expression
    - include: expression
    
  # SEQ

  seq:
    - match: '\['
      push:
        - seq_METASCOPE_POP
        - seq_2_POP

  seq_METASCOPE_POP:
    - meta_scope: meta.expression.seq.magma
    - match: ''
      pop: true

  seq_2_POP:
    - match: '\]'
      set: OPT_post_operator_POP
    - match: ':'
      set:
        - match: '\bin\b'
          scope: keyword.other.magma
          set:
            - match: '\]'
              set: OPT_post_operator_POP
            - match: '\|'
              set:
                - match: '\]'
                  set: OPT_post_operator_POP
                - include: expression
            - include: expression
        - include: expression
    - include: expression
    
  # ISET

  iset:
    - match: '\{@'
      push:
        - iset_METASCOPE_POP
        - iset_2_POP

  iset_METASCOPE_POP:
    - meta_scope: meta.expression.iset.magma
    - match: ''
      pop: true

  iset_2_POP:
    - match: '@\}'
      set: OPT_post_operator_POP
    - match: ':'
      set:
        - match: '\bin\b'
          scope: keyword.other.magma
          set:
            - match: '@\}'
              set: OPT_post_operator_POP
            - match: '\|'
              set:
                - match: '@\}'
                  set: OPT_post_operator_POP
                - include: expression
            - include: expression
        - include: expression
    - include: expression
    
  # MSET

  mset:
    - match: '\{\*'
      push:
        - mset_METASCOPE_POP
        - mset_2_POP

  mset_METASCOPE_POP:
    - meta_scope: meta.expression.mset.magma
    - match: ''
      pop: true

  mset_2_POP:
    - match: '\*\}'
      set: OPT_post_operator_POP
    - match: ':'
      set:
        - match: '\bin\b'
          scope: keyword.other.magma
          set:
            - match: '\*\}'
              set: OPT_post_operator_POP
            - match: '\|'
              set:
                - match: '\*\}'
                  set: OPT_post_operator_POP
                - include: expression
            - include: expression
        - include: expression
    - include: expression
    
  # TUPLE

  tuple:
    - match: '<'
      push:
        - tuple_METASCOPE_POP
        - tuple_2_POP

  tuple_METASCOPE_POP:
    - meta_scope: meta.expression.tuple.magma
    - match: ''
      pop: true

  tuple_2_POP:
    - match: '>'
      set: OPT_post_operator_POP
    - include: expression